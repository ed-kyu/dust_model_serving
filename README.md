# 특정 지역의 미세먼지(PM10) 예측 제공 API 개발

디렉토리 구조

```bash
├── app ├── model_pt_files
│   ├── main
│   ├── model
|	├── preprocess_data
|	├── train
│   └── inferences
├── Dockerfile
├── Dockerfile_local
├── crawling
├── dust_data.csv
├── heroku.yml
├── config.yaml
└── Procfile
```



## 1. Open API 크롤링
#### https://data.seoul.go.kr/dataList/OA-2220/S/1/datasetView.do OpenAPI를 이용하여 1년치 데이터를 크롤링하여 파일로 저장

##### crawling.py

1. `config.yaml` 파일에서 데이터를 크롤링할 날짜 시작일과 마지막일 관리

   1년치의 데이터말고도 원하는 구간의 데이터 크롤링 가능

2. api_key는 유출되면 안되므로 로컬 root 디렉토리에서 `secret.json`파일에 키를 저장해놓고 사용

   ```json
   {
     "SEOUL_CLIMATE_API_KEY" : "XXXXX"
   }
   ```

   다음과 같이 저장해놓고 사용하면 된다.



##### preprocessing_data.py

1. 저장된 csv파일을 판다스로 읽어서 모델이 학습하기 좋도록 바꾸는 작업
2. column명 이해하기 좋도록 날짜, 지역권, 지역으로 변경
3. 이상치 있는지 검사 후 지나치게 높은 값이 있는 column의 데이터는 사용하지 않도록 함
4. 리스트에 지역별로 데이터를 나눠 여러 개의 모델을 활용할 예정



## 2. 미세먼지 예측 모델 생성 및 저장
#### 미세먼지 미래 예측 모델을 제작. 미세먼지 예측 모델을 파일 형태로 저장



##### model.py

시계열 데이터를 활용하므로 LSTM 모델을 활용



##### train.py

1년치 데이터를 나눠서 train, valid set으로 활용 후

1년치 데이터를 모두 사용해서 train, api 요청 시 이후의 한달 동안의 미세먼지(PM10)를 예측하도록 제작

지역별로 데이터를 활용했으므로 25개의 지역의 모델 파일(pt) 모두 저장



##### inferences.py

크롤링한 데이터 이후 30일 동안의 PM10 수치 예측 결과를 반환



## 3. 예측 API개발
#### 저장된 모델을 로드하여 인퍼런스 호출을 할 수 있는 API를 제공. 인퍼런스 API에서는 특정 지역의 미세먼지 미래 예측 정보를 제공



##### FastAPI 활용

@app.get("/")  => index url

@app.get("/predict?region=마포구") => 다음과 같은 지역명이 들어간 쿼리url이 들어오면 지역에 맞는 모델을 불러와서 예측결과를 json으로 정리해 보여줌

쿼리에 이상한 지역이 오는 경우 Region not found를 리턴



## 4. 배포 준비
#### 해당 API서비스는 docker로 빌드하여 배포할 수 있도록 준비. docker run으로 해당 인퍼런스 API를 띄우고 테스트를 수행. 테스트 결과는 README.md 파일로 작성



로컬에서의 도커 파일과 heroku를 이용한 배포 버전의 도커 파일 2개 사용

##### 로컬에서의 도커 실행

```python
docker build . -t my-fastapi-app:local -f Dockerfile_local
docker run -p 8000:8000 my-fastapi-app:local
```

##### 테스트 결과(예시)

url : http://127.0.0.1:8000/predict/?region=마포구

지역명, 날짜와 날짜의 PM10 예측 수치가 나옴

```json
{
    "region":"마포구",
    "prediction":[
        {"day":"2022-10-21","PM10":102.58},{"day":"2022-10-22","PM10":169.053},{"day":"2022-10-23","PM10":85.347},{"day":"2022-10-24","PM10":0.0},{"day":"2022-10-25","PM10":0.0},{"day":"2022-10-26","PM10":0.0},{"day":"2022-10-27","PM10":4.545},{"day":"2022-10-28","PM10":57.157},{"day":"2022-10-29","PM10":21.114},{"day":"2022-10-30","PM10":76.495},{"day":"2022-10-31","PM10":191.01},{"day":"2022-11-01","PM10":142.193},{"day":"2022-11-02","PM10":0.273},{"day":"2022-11-03","PM10":0.79},{"day":"2022-11-04","PM10":0.0},{"day":"2022-11-05","PM10":1.626},{"day":"2022-11-06","PM10":49.549},{"day":"2022-11-07","PM10":37.695},{"day":"2022-11-08","PM10":54.162},{"day":"2022-11-09","PM10":164.698},{"day":"2022-11-10","PM10":166.783},{"day":"2022-11-11","PM10":35.823},{"day":"2022-11-12","PM10":0.0},{"day":"2022-11-13","PM10":0.0},{"day":"2022-11-14","PM10":0.0},{"day":"2022-11-15","PM10":37.567},{"day":"2022-11-16","PM10":48.397},{"day":"2022-11-17","PM10":33.332},{"day":"2022-11-18","PM10":137.271},{"day":"2022-11-19","PM10":185.663}
    ]
}
```



## 5. 아키텍처
#### 해당 서비스를 제공하기 위해 부하 분산 및 급격한 트래픽 변화 수용을 위한 클라우드 환경에서의 scalable한 아키텍처를 제안.
